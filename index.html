<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <!-- æ”¯æ´ iPhone ç€æµ·å®‰å…¨å€èˆ‡éŸ¿æ‡‰å¼ç¸®æ”¾ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é³³ç”²åœ‹ä¸­è¨­å‚™ç›¤é»</title>

  <!-- ZXing æ¢ç¢¼/QR æƒæåº« -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <style>
    /* ========== CSS æ¨£å¼å€åŸŸ ========== */
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f7f7f7;
      margin: 0; padding: 30px 0;
    }
    .main-wrapper {
      width: 1200px; max-width: 95%; margin: 0 auto;
    }
    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      padding: 24px 24px 32px;
      /* åº•éƒ¨é ç•™å®‰å…¨å€ */
      padding-bottom: max(32px, env(safe-area-inset-bottom));
    }
    h1 {
      font-size: 55px; text-align: center; margin: 10px 0 16px;
      letter-spacing: 2px;
      background: linear-gradient(90deg, #1565c0, #42a5f5);
      -webkit-background-clip: text; background-clip: text;
      color: transparent; font-weight: 900;
    }

    /* æƒæå€å¡Šä½ˆå±€ */
    .scanner-box {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 420px;
      grid-template-areas: "video side";
      gap: 24px; align-items: start; margin-top: 10px;
    }
    .video-wrap {
      grid-area: video; position: relative;
      background: #000; border-radius: 12px; overflow: hidden;
      min-height: 320px; aspect-ratio: 16 / 9;
    }
    video { width: 100%; height: 100%; display: block; object-fit: cover; }
    
    /* ç„æº–æ¡† */
    .reticle {
      position: absolute; inset: 0; pointer-events: none;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.08);
    }
    .reticle::before, .reticle::after {
      content: ""; position: absolute; width: 80px; height: 80px; border: 4px solid #00e676;
    }
    .reticle::before { top: 16px; left: 16px; border-right: none; border-bottom: none; }
    .reticle::after  { right: 16px; bottom: 16px; border-left: none; border-top: none; }

    /* å³å´æ“ä½œé¢æ¿ */
    .side-panel {
      grid-area: side; background: #fafafa;
      border: 1px solid #eee; border-radius: 12px; padding: 18px; align-self: start;
    }
    .field-label { font-size: 18px; color: #555; margin-bottom: 8px; }
    .scan-input {
      width: 90%; font-size: 26px; padding: 10px 12px;
      border: 2px solid #cfd8dc; border-radius: 10px; outline: none; background: #fff;
    }
    .scan-input:focus {
      border-color: #42a5f5; box-shadow: 0 0 0 4px rgba(66,165,245,0.15);
    }

    /* æŒ‰éˆ•ç¾¤çµ„ */
    .btn-row {
      display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; justify-content: center;
    }
    .btn {
      min-width: 120px; padding: 8px 12px; font-size: 20px;
      border: none; border-radius: 12px; cursor: pointer; color: #fff;
      transition: transform .05s ease, box-shadow .2s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .btn:active { transform: translateY(1px); }
    .btn-green { background: #2e7d32; }
    .btn-green:hover { box-shadow: 0 6px 16px rgba(46,125,50,0.35); }
    .btn-red { background: #c62828; }
    .btn-red:hover { box-shadow: 0 6px 16px rgba(198,40,40,0.35); }
    .btn-blue { background: #1565c0; }
    .btn-blue:hover { box-shadow: 0 6px 16px rgba(21,101,192,0.35); }
    .btn-yellow { background: #fbc02d; color: #000; }
    .btn-yellow:hover { box-shadow: 0 6px 16px rgba(251,192,45,0.35); }
    .btn-pink { background: #ec407a; }
    .btn-pink:hover { box-shadow: 0 6px 16px rgba(236,64,122,0.35); }
    .btn-nowrap{ white-space: nowrap; }

    /* ç‹€æ…‹é¡¯ç¤º */
    .status-row {
      display: flex; gap: 12px; align-items: center; margin-top: 12px;
      color: #666; font-size: 14px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #c62828; }
    .dot.on { background: #2e7d32; }

    /* æµ®å‹•æç¤º Toast */
    .toast {
      position: fixed; left: 50%; top: 60%; transform: translate(-50%, -50%);
      padding: 12px 18px; font-size: 26px; color: #fff; border-radius: 16px;
      z-index: 9999; opacity: 0; pointer-events: none;
      animation: fadeInOut 3s ease forwards; white-space: nowrap;
    }
    .toast.success { background: #2e7d32; }
    .toast.error   { background: #c62828; }
    .toast.info { background: #1565c0; }
    @keyframes fadeInOut {
      0%{ opacity:0; transform:translate(-50%, -6px); }
      10%{ opacity:1; transform:translate(-50%, 0); }
      80%{ opacity:1; }
      100%{ opacity:0; transform:translate(-50%, -6px); }
    }

    /* æ‰‹æ©Ÿç‰ˆé©æ‡‰ */
    @media (max-width: 1200px) {
      body { padding: 18px 0; }
      .main-wrapper { max-width: 100%; padding: 0 10px; }
      .container { padding: 16px; border-radius: 12px; }
      h1 { font-size: 30px; letter-spacing: 1px; }
      .scanner-box {
        grid-template-columns:1fr;
        grid-template-areas: "video" "side"; gap: 12px;
      }
      .video-wrap { min-height: 220px; aspect-ratio: 4 / 3; }
      .reticle::before, .reticle::after { width: 56px; height: 56px; border-width: 3px; }
      .side-panel { padding: 12px; margin-top: 6px; }
      .field-label { font-size: 16px; }
      .scan-input { font-size: 22px; padding: 10px; }
      .btn { font-size: 18px; padding: 12px 14px; }
      .status-row { font-size: 13px; }
      .toast { top: 12%; font-size: 22px; }
    }

    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-card{
      margin-top: 16px; background: #ffffff; border: 1px solid #e3f2fd;
      border-radius: 12px; padding: 14px; box-shadow: 0 6px 18px rgba(13,71,161,0.06);
    }
    .stats-title{
      font-size: 28px; font-weight: 800; color: #0d47a1;
      margin: 4px 4px 10px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;
    }
    .stats-title::before{
      content:""; width: 10px; height: 10px; border-radius: 50%; background:#42a5f5;
    }
    .stats-wrap{ overflow-x: auto; }
    .stats-table{ width: 100%; border-collapse: collapse; font-size: 26px; }
    .stats-table thead th{
      background: linear-gradient(90deg,#1565c0,#42a5f5);
      color:#fff; font-weight:700; padding: 10px 12px; text-align:center;
    }
    .stats-table td{ border: 1px solid #e0e0e0; padding: 10px 12px; text-align:center; }
    .stats-table tbody tr:nth-child(odd){ background:#fafafa; }
    #statsEmpty{ font-size: 16px; color:#888; padding: 10px 4px; text-align:center; }
    
    /* å ±å»¢æ¨™ç±¤ */
    .status-discard {
      background-color: #d32f2f; color: #fff; font-weight: bold;
      padding: 4px 8px; border-radius: 6px; display: inline-block;
    }

    /* æŸ¥è©¢çµæœå¡ç‰‡ */
    .result-card{
      margin-top: 16px; background: #fffde7; border: 1px solid #ffe082;
      border-radius: 12px; padding: 14px; box-shadow: 0 6px 18px rgba(255,193,7,0.12);
    }
    .result-title{
      font-size: 28px; font-weight: 800; color: #f57f17;
      margin: 4px 4px 10px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;
    }
    .result-title::before{
      content:""; width: 10px; height: 10px; border-radius: 50%; background:#ffca28;
    }
    .result-wrap{ overflow-x:auto; }
    .result-table{
      width: 100%; border-collapse: collapse; font-size: 20px; table-layout: fixed;
    }
    .result-table thead th{
      background: linear-gradient(90deg,#fbc02d,#ffd54f);
      color:#3e2723; font-weight:800; padding: 10px 12px; text-align:center; font-size: 24px;
    }
    .result-table td{
      border: 1px solid #ffe082; padding: 10px 12px;
      text-align: center; vertical-align: middle;
      word-break: break-word; white-space: normal;
    }

    /* è™•ç†ä¸­é®ç½©èˆ‡æ–‡å­— */
    .progress-toast{
      position: fixed; left: 50%; top: 18%; transform: translateX(-50%);
      min-width: 320px; background: #0d47a1; color: #fff; border-radius: 16px;
      padding: 14px 18px; z-index: 10000; box-shadow: 0 10px 24px rgba(0,0,0,.18);
      text-align: center; white-space: nowrap;
    }
    .progress-msg{ font-size: 26px; line-height: 1.25; }
    @media (max-width: 900px){
      .progress-msg{ font-size: 22px; }
      .stats-card{ padding: 12px; }
      .stats-title{ font-size: 26px; }
      .stats-table{ font-size: 24px; }
    }

    /* çµæ¡ˆå¯†ç¢¼ Modal */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: none; align-items: center; justify-content: center; z-index: 10050;
    }
    .modal{
      width: 92%; max-width: 420px; background: #fff; border-radius: 16px;
      box-shadow: 0 12px 36px rgba(0,0,0,.2); padding: 20px;
    }
    .modal h3{ margin: 0 0 10px 0; font-size: 24px; color:#c2185b; font-weight: 900; }
    .modal p{ margin: 6px 0 14px; color:#555; font-size: 16px; }
    .modal .row{ display:flex; gap:10px; align-items:center; }
    .modal input[type="password"]{
      flex:1; font-size: 22px; padding: 10px 12px;
      border: 2px solid #ffb6c1; border-radius: 10px; outline: none;
    }
    .modal input[type="password"]:focus{ border-color:#ec407a; box-shadow: 0 0 0 4px rgba(236,64,122,.15); }
    .modal .btn{ min-width: 110px; }
    .modal .btn-grey{ background:#90a4ae; }
    .modal .btn-grey:hover{ box-shadow:0 6px 16px rgba(144,164,174,.35); }
  </style>
</head>
<body>

<div class="main-wrapper">
  <div class="container">
    <h1>é³³ç”²åœ‹ä¸­è¨­å‚™ç›¤é»</h1>

    <div class="scanner-box">
      <!-- å·¦å´ï¼šç›¸æ©Ÿé è¦½ -->
      <div class="video-wrap">
        <video id="video" playsinline webkit-playsinline autoplay muted></video>
        <div class="reticle"></div>
      </div>

      <!-- å³å´ï¼šçµæœè¼¸å…¥ + æŒ‰éˆ• -->
      <div class="side-panel">
        <div class="field-label">æƒæçµæœè¼¸å…¥</div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <!-- âœ… ä¿®æ­£ 1ï¼šå¢åŠ  maxlength="12" é™åˆ¶è¼¸å…¥é•·åº¦ -->
          <input id="scanResult" class="scan-input" maxlength="12" placeholder="ç­‰å¾…æƒææˆ–æ‰‹å‹•è¼¸å…¥..." style="flex:1;" />
        </div>

        <div class="btn-row" style="margin-top:12px;">
          <button class="btn btn-blue" id="btnQuery">ğŸ” æŸ¥è©¢</button>
          <button class="btn btn-red" id="btnClear">ğŸ§¹ æ¸…é™¤</button>
          <button class="btn btn-yellow" id="btnSheet" >ğŸ“„ å·¥ä½œè¡¨</button>
          <button class="btn btn-pink" id="btnClose">ğŸ€ çµæ¡ˆ</button>
          <button class="btn btn-green btn-nowrap" id="btnCatalog">ğŸ“— è¨­å‚™æ¸…å†ŠæŸ¥è©¢</button>
          <button class="btn btn-blue" id="btnStartCamera" style="display:none;">ğŸ“· é‡å•Ÿç›¸æ©Ÿ</button>
        </div>
      </div>

      <div class="status-row">
        <div id="camDot" class="dot"></div>
        <div><b>ç›¸æ©Ÿ</b>ï¼š<span id="camStatus">åˆå§‹åŒ–ä¸­â€¦</span></div>
        <div style="margin-left:auto;">æ¯ 4 ç§’å¥åº·æª¢æŸ¥</div>
      </div>
    </div>
  </div>

  <!-- æŸ¥è©¢çµæœå€ -->
  <section id="resultCard" class="result-card" style="display:none;">
    <div class="result-title">æŸ¥è©¢çµæœ</div>
    <div class="result-wrap">
      <table id="resultTable" class="result-table" aria-label="æŸ¥è©¢çµæœ">
        <colgroup>
          <col style="width: 14%;"> <col style="width: 18%;"> <col style="width: 9%;">
          <col style="width: 13%;"> <col style="width: 16%;"> <col style="width: 8%;">
          <col style="width: 12%;"> <col style="width: 12%;">
        </colgroup>
        <thead>
          <tr>
            <th>ç·¨è™Ÿ</th> <th>åç¨±</th> <th>ç¸½åƒ¹</th> <th>å¹´é™</th>
            <th>æ¢ç¢¼</th> <th>æ¯”å°</th> <th>ç‹€æ…‹</th> <th>è™•ç†</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ç›¤é»çµ±è¨ˆè¡¨ -->
  <section class="stats-card" id="statsCard">
    <div class="stats-title">ç›¤é»çµ±è¨ˆè¡¨</div>
    <div class="stats-wrap">
      <table id="statsTable" class="stats-table" aria-label="ç›¤é»çµ±è¨ˆè¡¨" style="display:none;">
        <thead>
          <tr><th>é …ç›®</th><th>æ•¸é‡</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="statsEmpty">â€” è®€å–ä¸­â€¦ â€”</div>
    </div>
  </section>
</div>

<!-- çµæ¡ˆå¯†ç¢¼ Modal -->
<div id="closeModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="closeTitle">
    <h3 id="closeTitle">çµæ¡ˆç¢ºèª</h3>
    <p>æ­¤æ“ä½œå°‡æ¸…ç©ºç›¤é»å…¨éƒ¨è³‡æ–™ã€‚è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªï¼š</p>
    <div class="row" style="margin-bottom:12px;">
      <input id="closePwd" type="password" inputmode="numeric" autocomplete="off" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
    </div>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn btn-grey" id="btnCloseCancel">å–æ¶ˆ</button>
      <button class="btn btn-pink" id="btnCloseOk">ç¢ºå®šçµæ¡ˆ</button>
    </div>
  </div>
</div>

<script>
// ==========================================
// ğŸ”´ é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ–°çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (Deployment ID URL)
// 1. ç¢ºä¿ç¶²å€çµå°¾æ˜¯ /exec
// 2. ç¢ºä¿ GAS éƒ¨ç½²æ¬Šé™è¨­å®šç‚ºã€Œæ‰€æœ‰äºº (Anyone)ã€
// ==========================================
const GAS_API_URL = 'https://script.google.com/macros/s/ä½ çš„éƒ¨ç½²ID/exec'; 

// é€šç”¨ API å‘¼å«å‡½å¼ (å–ä»£ google.script.runï¼Œæ”¹ç”¨ fetch)
async function callGasApi(action, params = {}) {
  // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š URLï¼Œè‹¥ç„¡å‰‡æ‹‹å‡ºç‰¹å®šéŒ¯èª¤ä»¥ä¸­æ­¢è«‹æ±‚
  if (GAS_API_URL.includes('ä½ çš„éƒ¨ç½²ID') || !GAS_API_URL.startsWith('http')) {
    // ä½¿ç”¨ç‰¹å®šä»£ç¢¼ 'GAS_URL_NOT_SET'ï¼Œè®“å‘¼å«ç«¯å¯ä»¥å¿½ç•¥é€™å€‹éŒ¯èª¤
    throw new Error('GAS_URL_NOT_SET');
  }

  const payload = { action, ...params };
  try {
    const response = await fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
      // GAS Web App è¨­ç‚º "Anyone" æ¬Šé™å¾Œï¼Œæœƒè‡ªå‹•è™•ç† CORS
    });
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }

    const json = await response.json();
    return json;
  } catch (e) {
    console.error("API Error Details:", e);
    // æª¢æŸ¥æ˜¯å¦ç‚º CORS æˆ–æ¬Šé™éŒ¯èª¤
    if (e.message.includes('Failed to fetch')) {
        console.error('ğŸ’¡ æç¤ºï¼šè«‹æª¢æŸ¥ Google Apps Script éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äºº (Anyone)ã€ã€‚');
    }
    throw e;
  }
}

// ------------------------------------------------
// å…¨åŸŸè®Šæ•¸è¨­å®š
let statsTimer = null;
let statsBusy  = false;
let statsHash  = "";
let reader = null;
let scanning = false;
let hasWarnedUrl = false; // é¿å…é‡è¤‡è­¦å‘Š URL æœªè¨­å®š
let noCameraAvailable = false; // âœ… æ–°å¢ï¼šæ¨™è¨˜æ˜¯å¦æœ‰å¯ç”¨ç›¸æ©Ÿ

// DOM å…ƒç´ å¿«å–
const videoEl = document.getElementById('video');
const scanInput = document.getElementById('scanResult');
const camDot = document.getElementById('camDot');
const camStatus = document.getElementById('camStatus');
const btnStartCamera = document.getElementById('btnStartCamera');

// iOS è£ç½®åµæ¸¬
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

// æµ®å‹•æç¤ºé¡¯ç¤º
function showToast(msg, type = 'success', ms = 3000) {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), ms);
}

// æŸ¥è©¢é€²åº¦æ¢ (æ¨¡æ“¬)
let _progressEl = null, _progressTimer = null, _progressPct = 0;
function _ensureProgressEl(){
  if (_progressEl) return _progressEl;
  const box = document.createElement('div');
  box.className = 'progress-toast';
  box.innerHTML = `<div class="progress-msg" id="progressText">æŸ¥è©¢ä¸­â€¦è«‹ç¨å¾Œ 0%</div>`;
  document.body.appendChild(box);
  _progressEl = box;
  return _progressEl;
}
function _setProgress(p){
  const el = _ensureProgressEl().querySelector('#progressText');
  if (el) el.textContent = `æŸ¥è©¢ä¸­â€¦è«‹ç¨å¾Œ ${p}%`;
}
function showProgress(startPct = 0){
  _ensureProgressEl();
  _progressPct = Math.max(0, Math.min(100, startPct|0));
  _setProgress(_progressPct);
  _progressEl.style.display = 'block';
  if (_progressTimer) clearInterval(_progressTimer);
  _progressTimer = setInterval(() => {
    if (_progressPct >= 90) return;
    const step = Math.floor(Math.random() * 3) + 2;
    _progressPct = Math.min(90, _progressPct + step);
    _setProgress(_progressPct);
  }, 180);
}
function finishProgress(success = true){
  if (_progressTimer) { clearInterval(_progressTimer); _progressTimer = null; }
  if (!_progressEl) return;
  _progressPct = 100;
  _setProgress(_progressPct);
  setTimeout(() => { _progressEl.style.display = 'none'; }, 500);
}
function hideProgressNow(){
  if (_progressTimer) { clearInterval(_progressTimer); _progressTimer = null; }
  if (_progressEl) _progressEl.style.display = 'none';
}

// ç›¸æ©Ÿé‚è¼¯
let scanStartedAt = 0;
let cooling = false;

async function startScanner(fromUserGesture = false) {
  // âœ… 2. éŒ¯èª¤ä¿®æ­£ï¼šå¦‚æœå·²ç¶“ç¢ºå®šæ²’æœ‰ç›¸æ©Ÿï¼Œä¸”ä¸æ˜¯ä½¿ç”¨è€…æ‰‹å‹•è§¸ç™¼ï¼Œå°±ç›´æ¥è¿”å›ï¼Œé¿å…ç„¡é™å ±éŒ¯
  if (noCameraAvailable && !fromUserGesture) return;
  
  // âœ… 2. éŒ¯èª¤ä¿®æ­£ï¼šå¦‚æœæ˜¯ä½¿ç”¨è€…æ‰‹å‹•è§¸ç™¼ï¼Œé‡ç½®æ¨™è¨˜å†è©¦ä¸€æ¬¡
  if (fromUserGesture) noCameraAvailable = false;

  try {
    if (!navigator.mediaDevices) {
        throw new Error('Browser not support mediaDevices');
    }

    // âœ… ç§»é™¤åŸæœ¬åš´æ ¼çš„ enumerateDevices æª¢æŸ¥ï¼Œæ”¹ç”±åº«è‡ªå‹•è™•ç†ï¼Œå¤±æ•—å† catch
    // é€™å¯ä»¥é¿å…åœ¨æŸäº›è¨­å‚™ä¸Š enumerateDevices å›å‚³ç©ºä½†å…¶å¯¦æœ‰é è¨­ç›¸æ©Ÿçš„æƒ…æ³

    if (!reader) reader = new ZXing.BrowserMultiFormatReader();
    
    // ä½è€—èƒ½æ¨¡å¼è¨­å®š
    const lowPower = isIOS || window.innerWidth <= 900;
    if ('timeBetweenDecodingAttempts' in reader) {
      reader.timeBetweenDecodingAttempts = lowPower ? 400 : 250;
    } else if ('timeBetweenScansMillis' in reader) {
      reader.timeBetweenScansMillis = lowPower ? 400 : 250;
    }

    // å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿï¼šå„ªå…ˆä½¿ç”¨ environment (å¾Œé¡é ­)
    try {
        const constraints = {
            audio: false,
            video: {
                facingMode: { ideal: 'environment' },
                width:  { ideal: lowPower ? 640  : 1280 },
                height: { ideal: lowPower ? 480  : 720  },
                frameRate: lowPower ? { ideal: 24, max: 24 } : { ideal: 30, max: 30 }
            }
        };
        await reader.decodeFromConstraints(constraints, videoEl, onDecodeResult);
    } catch (envError) {
        console.warn('å¾Œé¡é ­å•Ÿå‹•å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ä»»æ„é¡é ­...', envError);
        // é™ç´šå˜—è©¦ï¼šä¸æŒ‡å®š facingModeï¼Œè®“ç€è¦½å™¨é¸é è¨­é¡é ­ (è§£æ±ºé›»è…¦ç‰ˆéŒ¯èª¤)
        await reader.decodeFromConstraints({ video: true }, videoEl, onDecodeResult);
    }

    if (btnStartCamera) btnStartCamera.style.display = 'none';

  } catch (e) {
    console.error('Camera Error:', e);
    scanning = false;
    scanStartedAt = 0;
    camStatus.textContent = 'ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—';
    camDot.classList.remove('on');

    // âœ… 2. éŒ¯èª¤ä¿®æ­£ï¼šæ•æ‰ NotFoundError ä¸¦è¨­ç½®æ¨™è¨˜ï¼Œé¡¯ç¤ºæŒ‰éˆ•
    if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError' || e.message.includes('No video input devices found')) {
         noCameraAvailable = true; 
         camStatus.textContent = 'æ‰¾ä¸åˆ°æ”å½±æ©Ÿ';
         
         // âœ… å¼·åˆ¶é¡¯ç¤ºé‡å•Ÿç›¸æ©ŸæŒ‰éˆ•
         if (btnStartCamera) {
             btnStartCamera.style.display = 'inline-block';
             btnStartCamera.textContent = 'ğŸ“· é‡å•Ÿç›¸æ©Ÿ';
         }

         // éœéŸ³éŒ¯èª¤æç¤ºï¼Œé™¤éæ˜¯ç”¨æˆ¶ä¸»å‹•é»æ“Š
         if (fromUserGesture) showToast('ğŸ“· æ‰¾ä¸åˆ°æ”å½±æ©Ÿè£ç½®', 'error');
    } else if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
         // æ¬Šé™éŒ¯èª¤ä¹Ÿé€šå¸¸æ˜¯æŒä¹…çš„ï¼Œè¨­ç‚ºä¸å¯ç”¨
         noCameraAvailable = true; 
         camStatus.textContent = 'ç„¡ç›¸æ©Ÿæ¬Šé™';
         if (btnStartCamera) btnStartCamera.style.display = 'inline-block';
         showToast('â›” è«‹å…è¨±ä½¿ç”¨ç›¸æ©Ÿ', 'error');
    } else {
        // å…¶ä»–éŒ¯èª¤ä¹Ÿé¡¯ç¤ºæŒ‰éˆ•ï¼Œä»¥ä¾¿é‡è©¦
        if (btnStartCamera) btnStartCamera.style.display = 'inline-block';
    }
  }
}

// æƒæå›èª¿å‡½å¼
function onDecodeResult(result, err) {
  scanning = true;
  if (!scanStartedAt) scanStartedAt = Date.now();
  camStatus.textContent = 'æƒæä¸­â€¦';
  camDot.classList.add('on');
  if (result) {
    const text = String(result.getText() || '').trim();
    if (text) {
      scanInput.value = text;
      stopScanner();
      runQuery(text); // æƒææˆåŠŸå¾Œè‡ªå‹•æŸ¥è©¢
    }
  }
}

// æ¸…é™¤å‰ç«¯æŸ¥è©¢çµæœ
function clearResult(){
  const card = document.getElementById('resultCard');
  const tbody = document.querySelector('#resultTable tbody');
  if (tbody) tbody.innerHTML = '';
  if (card) card.style.display = 'none';
}

// æ ¼å¼åŒ–ç‹€æ…‹ (å ±å»¢ç´…å­—)
function formatStatusHTML(s){
  const t = String(s ?? '');
  return t.includes('å ±å»¢') ? `<span class="status-discard">${t}</span>` : t;
}

// æ¸²æŸ“æŸ¥è©¢çµæœè¡¨æ ¼
function renderResult(row) {
  const card  = document.getElementById('resultCard');
  const tbody = document.querySelector('#resultTable tbody');
  if (!tbody) return;
  scanInput.value = '';
  tbody.innerHTML = '';
  const tr = document.createElement('tr');
  // å°æ‡‰ GAS å›å‚³çš„ç‰©ä»¶æ¬„ä½ A, B, F, H, J, K, L
  const cells = [row.A, row.B, row.F, row.H, row.J, row.K, row.L];

  cells.forEach((v, idx) => {
    const td = document.createElement('td');
    if (idx === 6) td.innerHTML = formatStatusHTML(v); // ç‹€æ…‹æ¬„ä½
    else td.textContent = v ?? '';
    tr.appendChild(td);
  });

  // æ“ä½œæŒ‰éˆ• (å ±å»¢)
  const tdAction   = document.createElement('td');
  const uploadBtn  = document.createElement('button');
  uploadBtn.textContent = 'å ±å»¢';
  uploadBtn.className   = 'btn btn-green';
  uploadBtn.style.minWidth = '80px';
  uploadBtn.style.fontSize = '20px';
  tdAction.appendChild(uploadBtn);
  tr.appendChild(tdAction);

  // å ±å»¢æŒ‰éˆ•é»æ“Šäº‹ä»¶
  uploadBtn.addEventListener('click', () => {
    const code = (row.J || '').trim();
    const matchCount = Number(row.K) || 0;
    const statusText = (row.L  || '').trim();

    if (statusText.includes('å ±å»¢')) { showToast('ğŸ›‘ æ­¤è¨­å‚™å·²å ±å»¢ï¼Œä¸ç”¨ä¸Šå‚³', 'info', 2500); return; }
    if (matchCount >= 1) { showToast('ğŸ“¦ è¨­å‚™å·²ä¸Šå‚³!', 'info', 2000); return; }
    if (!code) { showToast('â›” ç„¡æ¢ç¢¼ï¼Œç„¡æ³•ä¸Šå‚³', 'error', 2000); return; }

    uploadBtn.disabled = true;
    uploadBtn.style.opacity = 0.7;
    showProgress(0);

    // 1. å¯«å…¥ç›¤é»è¡¨
    callGasApi('addInventoryRecord', { code: code })
      .then(res => {
        finishProgress(true);
        if (res && res.ok) {
          showToast('âœ… æˆåŠŸä¸Šå‚³', 'success', 2000);
          loadStats(); // åˆ·æ–°çµ±è¨ˆ
          const newStatusText = `${formatRocDate()}æ“¬å ±å»¢`;

          // 2. æ›´æ–°è²¡ç”¢ç›®éŒ„ç‹€æ…‹ -> 3. é‡æ–°æŸ¥è©¢ä»¥æ›´æ–°ç•«é¢
          return callGasApi('updateAssetStatus', { code: code, statusText: newStatusText })
            .then(() => callGasApi('findAssetByBarcode', { barcode: code }))
            .then(updated => {
              if (updated && updated.found) {
                 tr.cells[5].textContent  = updated.row.K ?? '';
                 tr.cells[6].innerHTML    = formatStatusHTML(updated.row.L ?? '');
              }
              uploadBtn.disabled = false;
              uploadBtn.style.opacity = 1;
            });
        } else {
          throw new Error('Upload failed');
        }
      })
      .catch(err => {
        console.error(err);
        finishProgress(false);
        showToast('â›” ä¸Šå‚³/æ›´æ–°éŒ¯èª¤', 'error', 2000);
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = 1;
      });
  });

  tbody.appendChild(tr);
  card.style.display = 'block';
}

// è¼‰å…¥çµ±è¨ˆè³‡æ–™
function loadStats(){
  // æª¢æŸ¥ API URL æ˜¯å¦è¨­å®šï¼Œæœªè¨­å®šå‰‡ç›´æ¥ç•¥éï¼Œé¿å…å ±éŒ¯åˆ·å±
  if (GAS_API_URL.includes('ä½ çš„éƒ¨ç½²ID') || !GAS_API_URL.startsWith('http')) {
      if (!hasWarnedUrl) {
          console.warn('GAS URL æœªè¨­å®šï¼Œæš«åœè‡ªå‹•çµ±è¨ˆæ›´æ–°ã€‚');
          hasWarnedUrl = true; // åªè­¦å‘Šä¸€æ¬¡
      }
      return;
  }

  if (statsBusy) return;
  statsBusy = true;
  callGasApi('getStatsData')
    .then(data => {
      const table = document.getElementById('statsTable');
      const tbody = table.querySelector('tbody');
      const empty = document.getElementById('statsEmpty');
      const rows = (data && data.rows) || [];
      const nextHash = JSON.stringify(rows);
      if (nextHash === statsHash) { statsBusy = false; return; }
      statsHash = nextHash;
      tbody.innerHTML = '';
      if (rows.length === 0) {
        table.style.display = 'none';
        empty.textContent = 'â€” ç„¡çµ±è¨ˆè³‡æ–™ â€”';
        empty.style.display = 'block';
      } else {
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td'); td1.textContent = r[0] ?? '';
          const td2 = document.createElement('td'); td2.textContent = r[1] ?? '';
          tr.append(td1, td2);
          tbody.appendChild(tr);
        });
        empty.style.display = 'none';
        table.style.display = 'table';
      }
      statsBusy = false;
    })
    .catch(err => {
      // é¿å…æ´—ç‰ˆ Console
      if (err.message !== 'GAS_URL_NOT_SET') {
          console.error(err);
          const empty = document.getElementById('statsEmpty');
          empty.textContent = 'è®€å–çµ±è¨ˆå¤±æ•—';
          empty.style.display = 'block';
          document.getElementById('statsTable').style.display = 'none';
      }
      statsBusy = false;
    });
}

// è‡ªå‹•åˆ·æ–°çµ±è¨ˆ
function startStatsAutoRefresh(ms = 5000){
  if (statsTimer) clearInterval(statsTimer);
  statsTimer = setInterval(() => {
    if (document.visibilityState === 'visible') loadStats();
  }, ms);
}
function stopStatsAutoRefresh(){
  if (statsTimer) { clearInterval(statsTimer); statsTimer = null; }
}

// æƒæå™¨æ§åˆ¶
function requestCameraOnTap() { startScanner(true); }
function stopScanner() {
  try {
    if (reader) reader.reset();
    if (videoEl && videoEl.srcObject) {
      videoEl.srcObject.getTracks().forEach(t => t.stop());
      videoEl.srcObject = null;
    }
  } catch (_) {}
  scanning = false;
  scanStartedAt = 0;
  camStatus.textContent = 'å·²æš«åœ';
  camDot.classList.remove('on');
}
function restartScanner() {
  stopScanner();
  setTimeout(() => startScanner(false), 200);
}

// å¥åº·æª¢æŸ¥èˆ‡è‡ªå‹•é‡å•Ÿ
setInterval(() => {
  const empty = !scanInput.value.trim();
  // âœ… 2. éŒ¯èª¤ä¿®æ­£ï¼šåŠ å…¥ !noCameraAvailable æ¢ä»¶ï¼šå¦‚æœå·²ç¶“ç¢ºå®šæ²’ç›¸æ©Ÿï¼Œå°±ä¸è¦å†å˜—è©¦é‡å•Ÿ
  if (!scanning && empty && !cooling && !noCameraAvailable) { restartScanner(); return; }
  
  if (scanning && !cooling && scanStartedAt && (Date.now() - scanStartedAt > 40000)) {
    // æƒæå¤ªä¹…ä¼‘æ¯ä¸€ä¸‹
    cooling = true; stopScanner();
    setTimeout(() => {
      cooling = false;
      if (empty && !noCameraAvailable) startScanner(false); // âœ… é€™è£¡ä¹ŸåŠ 
    }, 2000);
  }
}, 4000);

// åŸ·è¡ŒæŸ¥è©¢
function runQuery(passedCode){
  const code = (passedCode ?? scanInput.value).trim();
  if (!code) { showToast('è«‹è¼¸å…¥æ¢ç¢¼!', 'error', 2000); scanInput.value = ''; return; }
  clearResult();
  const btn = document.getElementById('btnQuery');
  if (btn) { btn.disabled = true; btn.style.opacity = .7; }
  showProgress(0);

  callGasApi('findAssetByBarcode', { barcode: code })
    .then(res => {
      finishProgress(true);
      if (btn) { btn.disabled = false; btn.style.opacity = 1; }
      if (!res || !res.found) {
        showToast('æŸ¥ç„¡æ­¤è¨­å‚™è³‡æ–™!', 'error', 2000);
      } else {
        renderResult(res.row);
      }
      scanInput.value = '';
    })
    .catch(err => {
      // è‹¥æ˜¯å› ç‚º URL æœªè¨­å®šå°è‡´çš„éŒ¯èª¤ï¼Œä¸é¡¯ç¤ºæŸ¥è©¢å¤±æ•— Toast
      if (err.message !== 'GAS_URL_NOT_SET') {
          console.error(err);
          showToast('æŸ¥è©¢å¤±æ•—', 'error', 2000);
      }
      finishProgress(false);
      if (btn) { btn.disabled = false; btn.style.opacity = 1; }
      scanInput.value = '';
    });
}

// æ—¥æœŸæ ¼å¼åŒ– (æ°‘åœ‹å¹´)
function formatRocDate() {
  const d = new Date();
  return `${d.getFullYear()-1911}.${d.getMonth()+1}.${d.getDate()}`;
}

// æŒ‰éˆ•äº‹ä»¶ç¶å®š
document.getElementById('btnClear').addEventListener('click', () => {
  scanInput.value = '';
  clearResult();
  hideProgressNow();
  showToast('ğŸ§¹ å·²æ¸…é™¤ï¼Œé‡æ–°å•Ÿå‹•æƒæ', 'success',2000);
  restartScanner();
  scanInput.focus();
});
document.getElementById('btnSheet').addEventListener('click', () => {
  // é–‹å•Ÿå·¥ä½œè¡¨é€£çµ
  window.open('https://docs.google.com/spreadsheets/d/11KTGQY5DhUbPBTzFGGrGFhUHZoMa4FfKOYAQHq2P0Wo/edit?gid=68255210#gid=68255210', '_blank');
});

// çµæ¡ˆ Modal é‚è¼¯
const closeModal = document.getElementById('closeModal');
const closePwd   = document.getElementById('closePwd');
const btnCloseEl = document.getElementById('btnClose');
const btnCloseOk = document.getElementById('btnCloseOk');
const btnCloseCancel = document.getElementById('btnCloseCancel');

function openCloseModal(){ if(closeModal) { closePwd.value=''; closeModal.style.display='flex'; setTimeout(()=>closePwd.focus(),50); } }
function hideCloseModal(){ if(closeModal) closeModal.style.display='none'; }

btnCloseEl.addEventListener('click', openCloseModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'&&closeModal&&closeModal.style.display==='flex') hideCloseModal(); });
btnCloseCancel.addEventListener('click', hideCloseModal);
closePwd.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') btnCloseOk.click(); });
closeModal.addEventListener('click', (e)=>{ if (e.target === closeModal) hideCloseModal(); });

// ç¢ºå®šçµæ¡ˆ
btnCloseOk.addEventListener('click', () => {
  const pwd = (closePwd.value || '').trim();
  if (pwd !== '000000'){ showToast('â›” å¯†ç¢¼éŒ¯èª¤', 'error', 2000); closePwd.select(); return; }
  showProgress(0);
  btnCloseOk.disabled = true;

  callGasApi('clearLatestInventoryRow')
    .then(res => {
      finishProgress(true);
      btnCloseOk.disabled = false;
      if (res && res.ok){
        hideCloseModal();
        showToast('ğŸ€ å·²çµæ¡ˆï¼šç›¤é»è³‡æ–™æ¸…ç©º', 'success', 2200);
        clearResult();
        loadStats();
        restartScanner();
      } else {
        showToast('â›” çµæ¡ˆå¤±æ•—', 'error', 2200);
      }
    })
    .catch(err => {
      console.error(err);
      finishProgress(false);
      btnCloseOk.disabled = false;
      showToast('â›” çµæ¡ˆå¤±æ•—', 'error', 2200);
    });
});

// è¼¸å…¥æ¡† Enter äº‹ä»¶
scanInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { e.preventDefault(); runQuery(); }
});

// æƒææ§æ”¯æ´ (å¿«é€Ÿè¼¸å…¥åµæ¸¬)
(function enableScannerGunAutoQuery(){
  const el = document.getElementById('scanResult');
  if (!el) return;
  let lastTs = 0, fastStrokes = 0, idleTimer = null, firing = false;
  function trigger(reason = ''){
    if (firing) return;
    const v = (el.value || '').trim();
    if (!v) return;
    // é•·åº¦å¤§æ–¼ç­‰æ–¼6æ‰è¦–ç‚ºæœ‰æ•ˆæ¢ç¢¼
    if (v.length >= 6){
      firing = true;
      runQuery(v);
      setTimeout(()=>{ firing = false; }, 600);
    }
  }
  el.addEventListener('keydown', (e) => {
    const now = performance.now();
    const dt = now - lastTs;
    lastTs = now;
    // å¿«é€Ÿé€£çºŒè¼¸å…¥åˆ¤æ–·
    if (dt > 0 && dt < 35) fastStrokes++;
    if (e.key === 'Enter' || e.key === 'Tab'){ e.preventDefault(); trigger('enter/tab'); }
  });
  el.addEventListener('input', () => {
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
      // âœ… ä¿®æ­£ 1ï¼šæ”¾å¯¬åˆ¤æ–·æ¨™æº–
      // 1. å»¶é•· timeout åˆ° 500msï¼ˆåŸ 80msï¼‰ï¼Œå…è¨±æƒææ§é “ä¸€ä¸‹
      // 2. ç§»é™¤ç´”é•·åº¦åˆ¤æ–· (el.value.length >= 10)ï¼Œåªä¾é ã€Œå¿«é€Ÿè¼¸å…¥ã€ç‰¹å¾µä¾†è§¸ç™¼è‡ªå‹•é€å‡º
      // é€™æ¨£æ‰‹å‹•è¼¸å…¥é•·æ¢ç¢¼ä¸æœƒè¢«æ‰“æ–·ï¼Œæƒææ§è‹¥æœ‰é “é»ä¹Ÿä¸æœƒæ–·é–‹
      if (fastStrokes >= 3 && el.value.length >= 6){ trigger('idle'); }
      fastStrokes = 0;
    }, 500); // å»¶é•·è‡³ 500ms
  });
  el.addEventListener('paste', () => { setTimeout(() => trigger('paste'), 0); });
})();

// è¨­å‚™æ¸…å†Šé€£çµ
document.getElementById('btnCatalog').addEventListener('click', () => {
  // æ³¨æ„ï¼šé€™è£¡å¡«å¯«çš„æ˜¯è¨­å‚™æ¸…å†Šçš„ Viewer ç¶²å€ï¼Œå¦‚æœé‚„æ˜¯åŒä¸€å€‹ GAS å°ˆæ¡ˆçš„ GET å…¥å£ï¼Œå¯èƒ½éœ€è¦å¦å¤–è™•ç† doGet è·¯ç”±
  // ç›®å‰ä¿ç•™åŸæœ¬çš„é€£çµ
  window.open('https://script.google.com/macros/s/AKfycbz9Il_sTz9LeC-eq3rWmP21FxmrpOlx0JFOLl8H--y5JWJQF4YEESjqUqk0V5QFLNGiXA/exec', '_blank');
});
document.getElementById('btnQuery').addEventListener('click', () => { runQuery(); });
if (btnStartCamera) btnStartCamera.addEventListener('click', requestCameraOnTap);

// é˜²æ­¢è¼¸å…¥æ¡†è¢«éµç›¤é®æ“‹
scanInput.addEventListener('focus', () => {
  setTimeout(() => { scanInput.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
});

// åˆå§‹åŒ–
window.addEventListener('load', () => {
  startScanner(false);
  loadStats();
  startStatsAutoRefresh(5000);
  scanInput.focus();
});

// é é¢å¯è¦‹æ€§æ”¹è®Šæ™‚è™•ç† (çœé›»)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    stopStatsAutoRefresh();
    stopScanner();
  } else {
    if (!scanInput.value.trim()) restartScanner();
    startStatsAutoRefresh(5000);
  }
});
</script>
</body>
</html>